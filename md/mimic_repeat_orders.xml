<?xml version="1.0" encoding="utf-8"?>
<mdscript name="Mimic_Repeat_Orders" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <cues>

    <cue name="Main" version="4">
      <patch sinceversion="3">
        <do_if value="@$repeatOrdersCommanders == null">
          <create_group groupname="$repeatOrdersCommanders" />
        </do_if>
      </patch>
      <patch sinceversion="4">
        <set_value name="$refreshIteration" exact="1" />
      </patch>
      <actions>
        <debug_text text="'MimicRepeatOrders: Main'" chance="100" filter="scripts" />
        <do_if value="@$repeatOrdersCommanders == null">
          <create_group groupname="$repeatOrdersCommanders" />
        </do_if>
        <set_value name="$refreshIteration" exact="1" />
      </actions>
      <cues>
        <cue name="On_Reload" instantiate="true">
          <conditions>
            <event_ui_triggered screen="'MimicRepeatOrders'" control="'Reloaded'" />
          </conditions>
          <actions>
            <debug_text text="'MimicRepeatOrders: On_Reload'" chance="100" filter="scripts" />
            <signal_cue_instantly cue="Reloaded" />
          </actions>
        </cue>

        <cue name="On_Game_Loaded" instantiate="true">
          <conditions>
            <event_game_loaded />
          </conditions>
          <actions>
            <debug_text text="'MimicRepeatOrders: On_Game_Loaded'" chance="100" filter="general" />
            <signal_cue_instantly cue="Reloaded" />
          </actions>
        </cue>

        <cue name="Reloaded" instantiate="true" version="3">
          <conditions>
            <event_cue_signalled />
          </conditions>
          <actions>
            <debug_text text="'MimicRepeatOrders: Reloaded. Loop Orders Skill Limit: %s'.[@player.entity.$MimicRepeatOrdersLoopOrdersSkillLimit]" chance="100"
              filter="general" />
            <do_if value="@$repeatOrdersCommanders == null">
              <create_group groupname="$repeatOrdersCommanders" />
            </do_if>
            <set_value name="$refreshIteration" exact="10" />
            <include_actions ref="Repeat_Orders_Commanders_Refresh" />
          </actions>
        </cue>

        <cue name="Refresh_Repeat_Orders_Commanders" instantiate="true" checkinterval="3s">
          <actions>
            <debug_text text="'MimicRepeatOrders: Refresh_Repeat_Orders_Commanders. Iteration %s'.[@$refreshIteration]" chance="100" filter="scripts" />
            <include_actions ref="Repeat_Orders_Commanders_Refresh" />
          </actions>
        </cue>

        <cue name="Repeat_Orders_Commanders_Subordinate_Removed" instantiate="true">
          <conditions>
            <event_object_subordinate_removed group="@$repeatOrdersCommanders" check="false" />
            <check_value value="@event.param.hasorderloop" />
          </conditions>
          <actions>
            <debug_text
              text="'MimicRepeatOrders: Repeat_Orders_Commanders_Subordinate_Removed: subordinate %s was removed from commander %s, with mimic subordinates %s'.[@event.param.debugname, @event.object.debugname, @event.object.subordinates.{assignment.assist}.count]"
              chance="100"
              filter="scripts" />
            <do_if value="@event.object.subordinates.{assignment.assist}.count le 0">
              <remove_from_group group="$repeatOrdersCommanders" object="@event.object" />
            </do_if>
            <create_list name="$targetList" />
            <append_to_list name="$targetList" exact="@event.param" />
            <set_value name="$args"
              exact="table[
                $command            = 'clear_orders',
                $targets            = $targetList,
              ]" />
            <include_actions ref="Send_Request" />
          </actions>
        </cue>

        <cue name="Process_Mimic" instantiate="true" version="2">
          <conditions>
            <event_object_signalled object="player.entity" param="'mimic_repeat_orders_assign'" />
            <check_value value="@event.param2.isclass.ship" />
            <check_value value="@event.param2.trueowner == faction.player" />
            <check_value value="@event.param2.isoperational" />
            <check_value value="@event.param2.iswreck" negate="true" />
            <check_value value="@event.param2.hasorderloop" />
            <check_value value="@event.param3.isclass.ship" />
            <check_value value="@event.param3.trueowner == faction.player" />
            <check_value value="@event.param3.isoperational" />
            <check_value value="@event.param3.iswreck" negate="true" />
          </conditions>
          <actions>
            <create_list name="$targetList" />
            <append_to_list name="$targetList" exact="@event.param3" />
            <set_value name="$args"
              exact="table[
                $command            = 'clone_orders',
                $source             = @event.param2,
                $targets            = $targetList,
              ]" />
            <do_if value="@event.param2 != null and @$repeatOrdersCommanders != null and @$repeatOrdersCommanders.indexof.{@event.param2} le 0">
              <add_to_group groupname="$repeatOrdersCommanders" object="@event.param2" />
            </do_if>
            <include_actions ref="Send_Request" />
          </actions>
        </cue>

        <cue name="Process_Results" instantiate="true">
          <conditions>
            <event_ui_triggered screen="'MimicRepeatOrders'" control="'Response'" />
          </conditions>
          <actions>
            <debug_text
              text="'MimicRepeatOrders: Capture_Results invoked with data in $MimicRepeatOrdersResponse: %s'.[@player.entity.$MimicRepeatOrdersResponse]"
              chance="100" filter="scripts" />
            <!--Look
            up the action by id to get the callback.-->
            <set_value name="$result" exact="@player.entity.$MimicRepeatOrdersResponse" />
            <debug_text text="'MimicRepeatOrders: Process_Results invoked with result: %s'.[$result]" chance="100" filter="scripts" />
            <do_if value="$result? and @$result != null">
              <debug_text text="'MimicRepeatOrders: last command %s result: %s'.[@$result.$command, $result]" chance="100" filter="scripts" />
              <do_if value="@$result.$command == 'refresh_commanders'">
                <set_value name="$listCommanders" exact="$result.$list" />
                <do_for_each name="$commander" in="@$repeatOrdersCommanders.list">
                  <do_if value="$listCommanders.indexof.{@$commander} le 0">
                    <debug_text
                      text="'MimicRepeatOrders: Process_Results removing commander %s as it is no longer valid or has no mimic subordinates'.[@$commander.debugname]"
                      chance="100" filter="scripts" />
                    <remove_from_group group="$repeatOrdersCommanders" object="@$commander" />
                  </do_if>
                </do_for_each>
                <remove_value name="$listCommanders" />
              </do_if>
            </do_if>
          </actions>
        </cue>

        <library name="Send_Request" purpose="include_actions">
          <actions>
            <do_if value="$args? and @$args != null">
              <do_if value="not player.entity.$MimicRepeatOrdersRequest?">
                <set_value name="player.entity.$MimicRepeatOrdersRequest" exact="[]" />
              </do_if>
              <append_to_list name="player.entity.$MimicRepeatOrdersRequest" exact="$args" />
              <debug_text
                text="'MimicRepeatOrders: Send_Request, command: %s, args: %s'.[$args.$command, $args]" chance="100" filter="scripts" />
              <raise_lua_event name="'MimicRepeatOrders.Request'" />
            </do_if>
          </actions>
        </library>

        <library name="Repeat_Orders_Commanders_Refresh" purpose="include_actions">
          <actions>
            <debug_text
              text="'MimicRepeatOrders: Repeat_Orders_Commanders_Refresh, count: %s, iteration: %s'.[@$repeatOrdersCommanders.count, $refreshIteration]"
              chance="100" filter="scripts" />
            <do_if value="@$repeatOrdersCommanders == null">
              <create_group groupname="$repeatOrdersCommanders" />
            </do_if>
            <do_if value="@$repeatOrdersCommanders.count gt 0">
              <set_value name="$args"
                exact="table[
                  $command            = 'refresh_commanders',
                  $list               = @$repeatOrdersCommanders.list,
                  $checkSubordinates  = $refreshIteration == 10,
                ]" />
              <do_if value="$refreshIteration == 10">
                <set_value name="$refreshIteration" exact="1" />
              </do_if>
              <do_else>
                <set_value name="$refreshIteration" operation="add" />
              </do_else>
              <include_actions ref="Send_Request" />
            </do_if>
          </actions>
        </library>

      </cues>
    </cue>
  </cues>
</mdscript>